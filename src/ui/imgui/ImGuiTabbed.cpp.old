#include <imgui-cocos.hpp>
#include "ImGuiTabbed.hpp"
#include "../../Summit.hpp"
#include "../../mods/Mods.hpp"
#include "FontManager.hpp"
#include "../UIManager.hpp"

namespace summit::ui::imgui {

    void draw() {
        // TODO: this
        if (!summit::Config::getVisibility() || summit::ui::getUIType() != "ImGui Tabbed") return;
        ImGuiWindowFlags window_flags = ImGuiWindowFlags_NoResize | ImGuiWindowFlags_NoTitleBar | ImGuiWindowFlags_NoBackground | ImGuiWindowFlags_NoMove;
        for (auto tab : summit::mods::getTabs()) {
            ImGui::Begin(tab.c_str(), nullptr, window_flags);
            ImGui::SetWindowFontScale(1.f/3 * scale);
            ImGui::SetWindowSize(ImVec2(225.f * scale, 300.f * scale));
            if (firstDraw) {
                ImGui::SetWindowPos(windowPos);
                windowPos = ImVec2(windowPos.x + 235 * scale, windowPos.y);
            }
            auto drawList = ImGui::GetWindowDrawList();
            drawList->AddRectFilled(
                ImGui::GetWindowPos(),
                ImVec2(ImGui::GetWindowPos().x + ImGui::GetWindowWidth(), ImGui::GetWindowPos().y + ImGui::GetWindowHeight()),
                IM_COL32(47, 49, 66, 240)
            );
            drawList->AddRectFilled(
                ImGui::GetWindowPos(),
                ImVec2(ImGui::GetWindowPos().x + ImGui::GetWindowWidth(), ImGui::GetWindowPos().y + 30 * scale),
                IM_COL32(0, 174, 255, 255)
            );
            if (ImGui::GetIO().MouseDown[0]) {
                if (wasMouseDown) {
                    if (dragging == tab) {
                        ImGui::SetWindowPos(ImVec2(ImGui::GetWindowPos().x + ImGui::GetIO().MouseDelta.x, ImGui::GetWindowPos().y + ImGui::GetIO().MouseDelta.y));
                    }
                } else {
                    if (ImGui::IsMouseHoveringRect(ImGui::GetWindowPos(), ImVec2(ImGui::GetWindowPos().x + ImGui::GetWindowWidth(), ImGui::GetWindowPos().y + 30 * scale))) {
                        dragging = tab;
                        dragOffset = ImVec2(ImGui::GetIO().MousePos.x - ImGui::GetWindowPos().x, ImGui::GetIO().MousePos.y - ImGui::GetWindowPos().y);
                    }
                }
            } else {
                wasMouseDown = false;
                dragging = "";
            }
            ImGui::SetWindowFontScale(.5f * scale);
            ImGui::SetCursorPos(ImVec2(ImGui::GetWindowWidth() / 2 - ImGui::CalcTextSize(tab.c_str()).x / 2, 4 * scale));
            ImGui::Text("%s", tab.c_str());
            ImGui::SetCursorPos(ImVec2(8, 38 * scale));
            ImGui::SetWindowFontScale(1.f/3 * scale);
            for (auto mod : summit::mods::getModsInTab(tab)) {
                mod.second->renderImGui();
            }
            ImGui::End();
        }
        firstDraw = false;
        if (ImGui::GetIO().MouseDown[0]) {
            wasMouseDown = true;
        }
    }

    float getScale() {
        return scale;
    }

    void setScale(float newScale) {
        scale = newScale;
    }

    void init() {
        
    }

}

// $on_mod(Loaded) {
//     ImGuiCocos::get().setup([] {
//         summit::ui::imgui::init();
//     }).draw([] {
//         summit::ui::imgui::draw();
//     });
// }
